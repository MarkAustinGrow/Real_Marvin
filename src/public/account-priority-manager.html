<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Priority Manager - Marvin AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-image: url('images/Marvinbg.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding-top: 2rem;
      color: #333;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      max-width: 1600px;
    }
    .priority-high { background-color: #ffebee; }
    .priority-medium { background-color: #fff3e0; }
    .priority-low { background-color: #e8f5e8; }
    .quality-score {
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 12px;
      color: white;
    }
    .quality-high { background-color: #4caf50; }
    .quality-medium { background-color: #ff9800; }
    .quality-low { background-color: #f44336; }
    .api-usage-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    .api-usage-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    .usage-safe { background-color: #4caf50; }
    .usage-warning { background-color: #ff9800; }
    .usage-danger { background-color: #f44336; }
    .account-row {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .account-row:hover {
      background-color: rgba(0, 123, 255, 0.1);
    }
    .account-row.selected {
      background-color: rgba(0, 123, 255, 0.2);
    }
    .bulk-actions {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 100;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="text-primary">Account Priority Manager</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="refreshData()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <a href="/" class="btn btn-secondary">Back to Main</a>
      </div>
    </div>
    
    <!-- API Usage Dashboard -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">API Usage Dashboard</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="api-usage-bar mb-2">
              <div id="api-usage-fill" class="api-usage-fill usage-safe" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between">
              <span id="api-usage-text">Loading...</span>
              <span id="api-remaining-text">Remaining: --</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="row text-center">
              <div class="col-4">
                <div class="h4 mb-0" id="recommended-batch">--</div>
                <small class="text-muted">Recommended Batch</small>
              </div>
              <div class="col-4">
                <div class="h4 mb-0" id="total-accounts">--</div>
                <small class="text-muted">Total Accounts</small>
              </div>
              <div class="col-4">
                <div class="h4 mb-0" id="selected-count">0</div>
                <small class="text-muted">Selected</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bulk Actions -->
    <div class="bulk-actions">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex gap-2 align-items-center">
            <input type="checkbox" id="select-all" class="form-check-input">
            <label for="select-all" class="form-check-label">Select All</label>
            <span class="text-muted ms-2" id="selection-info">0 selected</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2 justify-content-end">
            <select id="bulk-priority" class="form-select" style="width: auto;" disabled>
              <option value="">Set Priority...</option>
              <option value="1">High (1)</option>
              <option value="2">Medium-High (2)</option>
              <option value="3">Medium (3)</option>
              <option value="4">Medium-Low (4)</option>
              <option value="5">Low (5)</option>
            </select>
            <select id="bulk-activity" class="form-select" style="width: auto;" disabled>
              <option value="">Set Activity...</option>
              <option value="high">High (Daily)</option>
              <option value="medium">Medium (3-day)</option>
              <option value="low">Low (Weekly)</option>
            </select>
            <button id="apply-bulk" class="btn btn-primary" disabled onclick="applyBulkChanges()">
              Apply Changes
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <label class="form-label">Filter by Priority:</label>
            <select id="filter-priority" class="form-select" onchange="applyFilters()">
              <option value="">All Priorities</option>
              <option value="1">High (1)</option>
              <option value="2">Medium-High (2)</option>
              <option value="3">Medium (3)</option>
              <option value="4">Medium-Low (4)</option>
              <option value="5">Low (5)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Filter by Activity:</label>
            <select id="filter-activity" class="form-select" onchange="applyFilters()">
              <option value="">All Activity Levels</option>
              <option value="high">High (Daily)</option>
              <option value="medium">Medium (3-day)</option>
              <option value="low">Low (Weekly)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Filter by Quality:</label>
            <select id="filter-quality" class="form-select" onchange="applyFilters()">
              <option value="">All Quality Scores</option>
              <option value="high">High (8-10)</option>
              <option value="medium">Medium (5-7)</option>
              <option value="low">Low (0-4)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Search:</label>
            <input type="text" id="search-handle" class="form-control" placeholder="Search handles..." onkeyup="applyFilters()">
          </div>
        </div>
      </div>
    </div>
    
    <!-- Accounts Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Account Management</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="40">
                  <input type="checkbox" id="header-select-all" class="form-check-input">
                </th>
                <th>Handle</th>
                <th>Priority</th>
                <th>Activity Level</th>
                <th>Quality Score</th>
                <th>Engagement</th>
                <th>Tweets</th>
                <th>Last Tweet</th>
                <th>Last Checked</th>
                <th>Next Check</th>
              </tr>
            </thead>
            <tbody id="accounts-table-body">
              <tr>
                <td colspan="10" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <div class="mt-2">Loading accounts...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Statistics -->
    <div class="row mt-4">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">High Priority</h5>
            <div class="h2 text-danger" id="high-priority-count">--</div>
            <small class="text-muted">Daily monitoring</small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Medium Priority</h5>
            <div class="h2 text-warning" id="medium-priority-count">--</div>
            <small class="text-muted">3-day monitoring</small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h5 class="card-title">Low Priority</h5>
            <div class="h2 text-success" id="low-priority-count">--</div>
            <small class="text-muted">Weekly monitoring</small>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let allAccounts = [];
    let filteredAccounts = [];
    let selectedAccounts = new Set();
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadAccountData();
      
      // Set up event listeners
      document.getElementById('select-all').addEventListener('change', toggleSelectAll);
      document.getElementById('header-select-all').addEventListener('change', toggleSelectAll);
    });
    
    async function loadAccountData() {
      try {
        const response = await fetch('/api/account-monitor/accounts-enhanced');
        const data = await response.json();
        
        if (data.success) {
          allAccounts = data.accounts;
          filteredAccounts = [...allAccounts];
          updateApiUsageDisplay(data.apiUsage);
          renderAccountsTable();
          updateStatistics();
        } else {
          console.error('Error loading accounts:', data.message);
          showError('Failed to load accounts: ' + data.message);
        }
      } catch (error) {
        console.error('Error loading accounts:', error);
        showError('Failed to load accounts. Please try again.');
      }
    }
    
    function updateApiUsageDisplay(apiUsage) {
      const fill = document.getElementById('api-usage-fill');
      const text = document.getElementById('api-usage-text');
      const remaining = document.getElementById('api-remaining-text');
      const batch = document.getElementById('recommended-batch');
      
      const percentage = apiUsage.percentageUsed;
      fill.style.width = percentage + '%';
      
      // Update color based on usage
      fill.className = 'api-usage-fill ' + 
        (percentage > 80 ? 'usage-danger' : 
         percentage > 60 ? 'usage-warning' : 'usage-safe');
      
      text.textContent = `${apiUsage.usedCalls}/250 calls used (${percentage.toFixed(1)}%)`;
      remaining.textContent = `Remaining: ${apiUsage.remainingCalls}`;
      batch.textContent = apiUsage.recommendedBatchSize;
      
      document.getElementById('total-accounts').textContent = allAccounts.length;
    }
    
    function renderAccountsTable() {
      const tbody = document.getElementById('accounts-table-body');
      
      if (filteredAccounts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-4">
              <div class="text-muted">No accounts match the current filters.</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = filteredAccounts.map(account => {
        const qualityScore = account.qualityMetrics?.qualityScore || 0;
        const qualityClass = qualityScore >= 8 ? 'quality-high' : 
                           qualityScore >= 5 ? 'quality-medium' : 'quality-low';
        
        const priorityClass = account.priority <= 2 ? 'priority-high' :
                             account.priority <= 3 ? 'priority-medium' : 'priority-low';
        
        const lastTweet = account.qualityMetrics?.lastTweetDate ? 
          new Date(account.qualityMetrics.lastTweetDate).toLocaleDateString() : 'Never';
        
        const lastChecked = account.last_checked ? 
          new Date(account.last_checked).toLocaleDateString() : 'Never';
        
        const nextCheck = account.next_check_date ? 
          new Date(account.next_check_date).toLocaleDateString() : 'ASAP';
        
        const isSelected = selectedAccounts.has(account.id);
        
        return `
          <tr class="account-row ${priorityClass} ${isSelected ? 'selected' : ''}" 
              onclick="toggleAccountSelection(${account.id})">
            <td onclick="event.stopPropagation()">
              <input type="checkbox" class="form-check-input account-checkbox" 
                     data-account-id="${account.id}" ${isSelected ? 'checked' : ''}
                     onchange="toggleAccountSelection(${account.id})">
            </td>
            <td>
              <strong>@${account.handle}</strong>
              <br><small class="text-muted">ID: ${account.id}</small>
            </td>
            <td>
              <select class="form-select form-select-sm" 
                      onchange="updateAccountProperty(${account.id}, 'priority', this.value)"
                      onclick="event.stopPropagation()">
                <option value="1" ${account.priority === 1 ? 'selected' : ''}>High (1)</option>
                <option value="2" ${account.priority === 2 ? 'selected' : ''}>Medium-High (2)</option>
                <option value="3" ${account.priority === 3 ? 'selected' : ''}>Medium (3)</option>
                <option value="4" ${account.priority === 4 ? 'selected' : ''}>Medium-Low (4)</option>
                <option value="5" ${account.priority === 5 ? 'selected' : ''}>Low (5)</option>
              </select>
            </td>
            <td>
              <select class="form-select form-select-sm" 
                      onchange="updateAccountProperty(${account.id}, 'activity_level', this.value)"
                      onclick="event.stopPropagation()">
                <option value="high" ${account.activity_level === 'high' ? 'selected' : ''}>High (Daily)</option>
                <option value="medium" ${account.activity_level === 'medium' ? 'selected' : ''}>Medium (3-day)</option>
                <option value="low" ${account.activity_level === 'low' ? 'selected' : ''}>Low (Weekly)</option>
              </select>
            </td>
            <td>
              <span class="quality-score ${qualityClass}">
                ${qualityScore.toFixed(1)}
              </span>
            </td>
            <td>${account.qualityMetrics?.avgEngagement?.toFixed(1) || '0.0'}</td>
            <td>${account.qualityMetrics?.tweetCount || 0}</td>
            <td>${lastTweet}</td>
            <td>${lastChecked}</td>
            <td>${nextCheck}</td>
          </tr>
        `;
      }).join('');
    }
    
    function toggleAccountSelection(accountId) {
      if (selectedAccounts.has(accountId)) {
        selectedAccounts.delete(accountId);
      } else {
        selectedAccounts.add(accountId);
      }
      
      updateSelectionUI();
      renderAccountsTable();
    }
    
    function toggleSelectAll() {
      const selectAll = document.getElementById('select-all').checked;
      
      if (selectAll) {
        filteredAccounts.forEach(account => selectedAccounts.add(account.id));
      } else {
        selectedAccounts.clear();
      }
      
      updateSelectionUI();
      renderAccountsTable();
    }
    
    function updateSelectionUI() {
      const count = selectedAccounts.size;
      document.getElementById('selected-count').textContent = count;
      document.getElementById('selection-info').textContent = `${count} selected`;
      
      // Enable/disable bulk action controls
      const hasSelection = count > 0;
      document.getElementById('bulk-priority').disabled = !hasSelection;
      document.getElementById('bulk-activity').disabled = !hasSelection;
      document.getElementById('apply-bulk').disabled = !hasSelection;
      
      // Update select all checkbox
      const selectAllCheckbox = document.getElementById('select-all');
      const headerSelectAllCheckbox = document.getElementById('header-select-all');
      
      if (count === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
        headerSelectAllCheckbox.indeterminate = false;
        headerSelectAllCheckbox.checked = false;
      } else if (count === filteredAccounts.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
        headerSelectAllCheckbox.indeterminate = false;
        headerSelectAllCheckbox.checked = true;
      } else {
        selectAllCheckbox.indeterminate = true;
        headerSelectAllCheckbox.indeterminate = true;
      }
    }
    
    async function updateAccountProperty(accountId, property, value) {
      try {
        const response = await fetch('/api/account-monitor/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            accountId: accountId,
            properties: {
              [property]: property === 'priority' ? parseInt(value) : value
            }
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update local data
          const account = allAccounts.find(a => a.id === accountId);
          if (account) {
            account[property] = property === 'priority' ? parseInt(value) : value;
          }
          
          updateStatistics();
          showSuccess(`Updated ${property} for account`);
        } else {
          showError('Failed to update account: ' + data.message);
          // Reload to reset the UI
          loadAccountData();
        }
      } catch (error) {
        console.error('Error updating account:', error);
        showError('Failed to update account. Please try again.');
        loadAccountData();
      }
    }
    
    async function applyBulkChanges() {
      const priority = document.getElementById('bulk-priority').value;
      const activity = document.getElementById('bulk-activity').value;
      
      if (!priority && !activity) {
        showError('Please select a priority or activity level to apply.');
        return;
      }
      
      const updates = Array.from(selectedAccounts).map(accountId => {
        const properties = {};
        if (priority) properties.priority = parseInt(priority);
        if (activity) properties.activity_level = activity;
        
        return {
          accountId: accountId,
          properties: properties
        };
      });
      
      try {
        document.body.classList.add('loading');
        
        const response = await fetch('/api/account-monitor/bulk-update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ updates })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess(`Successfully updated ${data.successCount} accounts`);
          
          // Clear selections and reset bulk controls
          selectedAccounts.clear();
          document.getElementById('bulk-priority').value = '';
          document.getElementById('bulk-activity').value = '';
          updateSelectionUI();
          
          // Reload data
          await loadAccountData();
        } else {
          showError('Bulk update failed: ' + data.message);
          if (data.errors) {
            console.error('Bulk update errors:', data.errors);
          }
        }
      } catch (error) {
        console.error('Error in bulk update:', error);
        showError('Failed to apply bulk changes. Please try again.');
      } finally {
        document.body.classList.remove('loading');
      }
    }
    
    function applyFilters() {
      const priorityFilter = document.getElementById('filter-priority').value;
      const activityFilter = document.getElementById('filter-activity').value;
      const qualityFilter = document.getElementById('filter-quality').value;
      const searchFilter = document.getElementById('search-handle').value.toLowerCase();
      
      filteredAccounts = allAccounts.filter(account => {
        // Priority filter
        if (priorityFilter && account.priority.toString() !== priorityFilter) {
          return false;
        }
        
        // Activity filter
        if (activityFilter && account.activity_level !== activityFilter) {
          return false;
        }
        
        // Quality filter
        if (qualityFilter) {
          const qualityScore = account.qualityMetrics?.qualityScore || 0;
          if (qualityFilter === 'high' && qualityScore < 8) return false;
          if (qualityFilter === 'medium' && (qualityScore < 5 || qualityScore >= 8)) return false;
          if (qualityFilter === 'low' && qualityScore >= 5) return false;
        }
        
        // Search filter
        if (searchFilter && !account.handle.toLowerCase().includes(searchFilter)) {
          return false;
        }
        
        return true;
      });
      
      // Clear selections that are no longer visible
      const visibleAccountIds = new Set(filteredAccounts.map(a => a.id));
      selectedAccounts = new Set([...selectedAccounts].filter(id => visibleAccountIds.has(id)));
      
      updateSelectionUI();
      renderAccountsTable();
    }
    
    function updateStatistics() {
      const highPriority = allAccounts.filter(a => a.priority <= 2).length;
      const mediumPriority = allAccounts.filter(a => a.priority === 3).length;
      const lowPriority = allAccounts.filter(a => a.priority >= 4).length;
      
      document.getElementById('high-priority-count').textContent = highPriority;
      document.getElementById('medium-priority-count').textContent = mediumPriority;
      document.getElementById('low-priority-count').textContent = lowPriority;
    }
    
    function refreshData() {
      selectedAccounts.clear();
      updateSelectionUI();
      loadAccountData();
    }
    
    function showSuccess(message) {
      // Simple success notification
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
      alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.parentNode.removeChild(alert);
        }
      }, 5000);
    }
    
    function showError(message) {
      // Simple error notification
      const alert = document.createElement('div');
      alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
      alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.parentNode.removeChild(alert);
        }
      }, 8000);
    }
  </script>
</body>
</html>
