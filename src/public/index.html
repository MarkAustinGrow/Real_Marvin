<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marvin AI Agent - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body {
      background-image: url('images/Marvinbg.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding-top: 2rem;
      color: #333;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    .tweet-preview {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      background-color: white;
    }
    .status-card {
      margin-bottom: 20px;
    }
    .hashtags {
      color: #1DA1F2;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #1DA1F2;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Marvin AI Agent - Admin Interface</h1>
    
    <div class="row">
      <div class="col-md-4">
        <div class="card status-card">
          <div class="card-header">Status</div>
          <div class="card-body" id="status-container">
            <p>Loading status...</p>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">Generate Test Tweet</div>
          <div class="card-body">
            <form id="tweet-form">
              <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" required>
                  <option value="" disabled selected>Select a category</option>
                  <!-- Categories will be loaded dynamically -->
                </select>
              </div>
              
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="preview-btn">Preview Tweet</button>
                <button type="submit" class="btn btn-danger">Post Test Tweet</button>
              </div>
            </form>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">Generate Blog Post</div>
          <div class="card-body">
            <p class="text-muted">Generate a blog post with Marvin's unique style and perspective.</p>
            
            <div class="mb-3">
              <label for="blog-theme" class="form-label">Theme</label>
              <input type="text" class="form-control" id="blog-theme" placeholder="e.g., technology, AI ethics, creativity">
            </div>
            
            <div class="mb-3">
              <label for="blog-tags" class="form-label">Tags (comma-separated)</label>
              <input type="text" class="form-control" id="blog-tags" placeholder="e.g., AI, philosophy, art">
            </div>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="use-memory-checkbox" checked>
              <label class="form-check-label" for="use-memory-checkbox">
                Use Memory (include relevant memories in generation)
              </label>
            </div>
            
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary" id="generate-blog-post-btn">Generate Blog Post</button>
            </div>
            
            <div class="mt-4" id="blog-post-preview" style="display: none;">
              <h5>Blog Post Preview</h5>
              
              <div class="card mb-3">
                <div class="card-body">
                  <h3 id="blog-post-title"></h3>
                  <p class="text-muted" id="blog-post-excerpt"></p>
                  <hr>
                  <div id="blog-post-content" class="markdown-content"></div>
                </div>
              </div>
              
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-secondary" id="regenerate-blog-post-btn">Regenerate</button>
                <button type="button" class="btn btn-success" id="save-as-draft-btn">Save as Draft</button>
                <button type="button" class="btn btn-danger" id="mark-as-ready-btn">Mark as Ready to Tweet</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">Test Blog Post</div>
          <div class="card-body">
            <p class="text-muted">Test the blog post scheduler to check for and post any blog posts with "ready_to_tweet" status.</p>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="dry-run-checkbox" checked>
              <label class="form-check-label" for="dry-run-checkbox">
                Dry Run Mode (simulate posting without actually posting to Twitter)
              </label>
            </div>
            
            <div class="d-grid">
              <button type="button" class="btn btn-primary" id="test-blog-post-btn">Test Blog Post</button>
            </div>
            
            <div class="mt-3" id="blog-post-result" style="display: none;">
              <div class="alert alert-info">
                <h5 id="blog-post-result-title">Results:</h5>
                <p id="blog-post-result-message"></p>
                <div id="blog-post-result-details"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mt-4">
          <div class="card-header">Engagement Rules</div>
          <div class="card-body">
            <div id="rules-container">
              <p>Loading engagement rules...</p>
            </div>
            <div class="d-grid gap-2 mt-3">
              <button type="button" class="btn btn-primary" id="add-rule-btn">Add Rule</button>
              <button type="button" class="btn btn-success" id="save-rules-btn">Save Rules</button>
            </div>
          </div>
        </div>
        
        <div class="card mt-4">
          <div class="card-header">Account Monitoring</div>
          <div class="card-body">
            <p class="text-muted">Monitor X accounts and cache their tweets for analysis.</p>
            
            <ul class="nav nav-tabs mb-3" id="accountTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts-content" type="button" role="tab" aria-controls="accounts-content" aria-selected="true">Accounts</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tweets-tab" data-bs-toggle="tab" data-bs-target="#tweets-content" type="button" role="tab" aria-controls="tweets-content" aria-selected="false">Tweets</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="process-tab" data-bs-toggle="tab" data-bs-target="#process-content" type="button" role="tab" aria-controls="process-content" aria-selected="false">Process</button>
              </li>
            </ul>
            
            <div class="tab-content" id="accountTabsContent">
              <div class="tab-pane fade show active" id="accounts-content" role="tabpanel" aria-labelledby="accounts-tab">
                <div id="accounts-container">
                  <p>Loading accounts...</p>
                </div>
                
                <div class="mt-3">
                  <h5>Add Account</h5>
                  <form id="add-account-form">
                    <div class="mb-3">
                      <label for="account-handle" class="form-label">Handle (without @)</label>
                      <input type="text" class="form-control" id="account-handle" required>
                    </div>
                    
                    <div class="mb-3">
                      <label for="account-priority" class="form-label">Priority (1-5, 1 is highest)</label>
                      <input type="number" class="form-control" id="account-priority" min="1" max="5" value="3">
                    </div>
                    
                    <div class="mb-3">
                      <label for="account-activity" class="form-label">Activity Level</label>
                      <select class="form-select" id="account-activity">
                        <option value="high">High (check daily)</option>
                        <option value="medium" selected>Medium (check every 3 days)</option>
                        <option value="low">Low (check weekly)</option>
                      </select>
                    </div>
                    
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">Add Account</button>
                    </div>
                  </form>
                </div>
              </div>
              
              <div class="tab-pane fade" id="tweets-content" role="tabpanel" aria-labelledby="tweets-tab">
                <div class="mb-3">
                  <label for="tweet-account-select" class="form-label">Select Account</label>
                  <select class="form-select" id="tweet-account-select">
                    <option value="" disabled selected>Select an account</option>
                  </select>
                </div>
                
                <div id="tweets-container">
                  <p>Select an account to view tweets</p>
                </div>
                
                <div class="d-grid gap-2 mt-3">
                  <button type="button" class="btn btn-primary" id="fetch-tweets-btn" disabled>Fetch Tweets</button>
                </div>
              </div>
              
              <div class="tab-pane fade" id="process-content" role="tabpanel" aria-labelledby="process-tab">
                <p>Process accounts that are due for checking.</p>
                
                <div class="mb-3">
                  <label for="batch-size" class="form-label">Batch Size</label>
                  <input type="number" class="form-control" id="batch-size" min="1" value="10">
                </div>
                
                <div class="d-grid">
                  <button type="button" class="btn btn-primary" id="process-accounts-btn">Process Accounts</button>
                </div>
                
                <div class="mt-3" id="process-result" style="display: none;">
                  <div class="alert alert-info">
                    <p id="process-result-message"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-8">
        <div class="tweet-preview" id="preview-container">
          <h5>Tweet Preview</h5>
          <p class="text-muted">Generate a preview to see how your tweet will look</p>
          <div id="tweet-content"></div>
          <div id="tweet-hashtags" class="hashtags mt-2"></div>
        </div>
        
        <div class="alert alert-info mt-3" role="alert">
          <h5>Note:</h5>
          <p>This interface allows you to test tweet generation and posting outside of the scheduled times (9 AM and 5 PM).</p>
          <p>Use the "Preview" button to see how a tweet will look without posting it.</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Blog Post Generation
      document.getElementById('generate-blog-post-btn').addEventListener('click', function() {
        const button = document.getElementById('generate-blog-post-btn');
        const theme = document.getElementById('blog-theme').value || 'technology';
        const useMemory = document.getElementById('use-memory-checkbox').checked;
        
        // Update button state
        button.disabled = true;
        button.textContent = 'Generating...';
        
        // Hide preview if visible
        document.getElementById('blog-post-preview').style.display = 'none';
        
        // Make API request
        fetch('/api/generate-blog-post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            theme: theme,
            useMemory: useMemory,
            dryRun: true // Don't save to database yet
          })
        })
        .then(response => response.json())
        .then(data => {
          // Update button state
          button.disabled = false;
          button.textContent = 'Generate Blog Post';
          
          if (data.success) {
            // Show preview
            document.getElementById('blog-post-title').textContent = data.blogPost.title;
            document.getElementById('blog-post-excerpt').textContent = data.blogPost.excerpt;
            
            // Render markdown content
            const renderedContent = marked.parse(data.blogPost.content);
            document.getElementById('blog-post-content').innerHTML = renderedContent;
            
            // Show preview container
            document.getElementById('blog-post-preview').style.display = 'block';
            
            // Set up regenerate button
            document.getElementById('regenerate-blog-post-btn').onclick = function() {
              document.getElementById('generate-blog-post-btn').click();
            };
            
            // Set up save as draft button
            document.getElementById('save-as-draft-btn').onclick = function() {
              saveBlogPost('draft');
            };
            
            // Set up mark as ready button
            document.getElementById('mark-as-ready-btn').onclick = function() {
              saveBlogPost('ready_to_tweet');
            };
          } else {
            alert('Error generating blog post: ' + data.message);
          }
        })
        .catch(error => {
          button.disabled = false;
          button.textContent = 'Generate Blog Post';
          console.error('Error:', error);
          alert('Failed to generate blog post. Please try again.');
        });
      });
      
      // Function to save blog post
      function saveBlogPost(status) {
        const theme = document.getElementById('blog-theme').value || 'technology';
        const tags = document.getElementById('blog-tags').value;
        const useMemory = document.getElementById('use-memory-checkbox').checked;
        const title = document.getElementById('blog-post-title').textContent;
        const content = document.getElementById('blog-post-content').innerHTML;
        
        // Disable buttons
        document.getElementById('regenerate-blog-post-btn').disabled = true;
        document.getElementById('save-as-draft-btn').disabled = true;
        document.getElementById('mark-as-ready-btn').disabled = true;
        
        // Make API request to save
        fetch('/api/generate-blog-post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            theme: theme,
            tags: tags,
            useMemory: useMemory,
            status: status,
            dryRun: false
          })
        })
        .then(response => response.json())
        .then(data => {
          // Re-enable buttons
          document.getElementById('regenerate-blog-post-btn').disabled = false;
          document.getElementById('save-as-draft-btn').disabled = false;
          document.getElementById('mark-as-ready-btn').disabled = false;
          
          if (data.success) {
            alert(`Blog post ${status === 'draft' ? 'saved as draft' : 'marked as ready to tweet'}!`);
            
            // Clear form
            document.getElementById('blog-theme').value = '';
            document.getElementById('blog-tags').value = '';
            document.getElementById('blog-post-preview').style.display = 'none';
          } else {
            alert('Error saving blog post: ' + data.message);
          }
        })
        .catch(error => {
          // Re-enable buttons
          document.getElementById('regenerate-blog-post-btn').disabled = false;
          document.getElementById('save-as-draft-btn').disabled = false;
          document.getElementById('mark-as-ready-btn').disabled = false;
          
          console.error('Error:', error);
          alert('Failed to save blog post. Please try again.');
        });
      }
      
      // Test Blog Post functionality
      document.getElementById('test-blog-post-btn').addEventListener('click', function() {
        const button = document.getElementById('test-blog-post-btn');
        const resultContainer = document.getElementById('blog-post-result');
        const resultTitle = document.getElementById('blog-post-result-title');
        const resultMessage = document.getElementById('blog-post-result-message');
        const resultDetails = document.getElementById('blog-post-result-details');
        const dryRun = document.getElementById('dry-run-checkbox').checked;
        
        // Update button state
        button.disabled = true;
        button.textContent = 'Processing...';
        
        // Clear previous results
        resultMessage.textContent = '';
        resultDetails.innerHTML = '';
        resultContainer.style.display = 'none';
        
        // Make API request
        fetch('/api/test-blog-post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dryRun: dryRun
          })
        })
        .then(response => response.json())
        .then(data => {
          // Update button state
          button.disabled = false;
          button.textContent = 'Test Blog Post';
          
          // Show result container
          resultContainer.style.display = 'block';
          
          // Update result message
          if (data.success) {
            resultTitle.textContent = dryRun ? 'Dry Run Results:' : 'Results:';
            resultMessage.textContent = data.message;
            
            // Display post details if available
            if (data.posts && data.posts.length > 0) {
              const detailsHtml = data.posts.map(post => {
                const statusClass = post.status === 'success' ? 'text-success' : 
                                   post.status === 'error' ? 'text-danger' : 'text-warning';
                
                return `
                  <div class="card mb-2">
                    <div class="card-body">
                      <h6>${post.title}</h6>
                      <p class="${statusClass}">Status: ${post.status}</p>
                      ${post.error ? `<p class="text-danger">Error: ${post.error}</p>` : ''}
                    </div>
                  </div>
                `;
              }).join('');
              
              resultDetails.innerHTML = detailsHtml;
            } else {
              resultDetails.innerHTML = '<p>No blog posts were found with "ready_to_tweet" status.</p>';
            }
          } else {
            resultTitle.textContent = 'Error:';
            resultMessage.textContent = data.message || 'An unknown error occurred';
            resultContainer.classList.remove('alert-info');
            resultContainer.classList.add('alert-danger');
          }
        })
        .catch(error => {
          // Update button state
          button.disabled = false;
          button.textContent = 'Test Blog Post';
          
          // Show error
          resultContainer.style.display = 'block';
          resultTitle.textContent = 'Error:';
          resultMessage.textContent = 'Failed to test blog post. Please try again.';
          console.error('Error:', error);
        });
      });
      
      // Load categories
      fetch('/api/categories')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('category');
          data.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          alert('Failed to load categories. Please refresh the page.');
        });
      
      // Load status
      function updateStatus() {
        fetch('/api/status')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('status-container');
            const nextTweetDate = new Date(data.nextScheduledTweet);
            const hoursUntil = Math.floor(data.timeUntilNextTweet / (1000 * 60 * 60));
            const minutesUntil = Math.floor((data.timeUntilNextTweet % (1000 * 60 * 60)) / (1000 * 60));
            
            container.innerHTML = `
              <p><strong>Status:</strong> ${data.status}</p>
              <p><strong>Next scheduled tweet:</strong><br>${nextTweetDate.toLocaleString()}</p>
              <p><strong>Time until next tweet:</strong><br>${hoursUntil}h ${minutesUntil}m</p>
            `;
          })
          .catch(error => {
            console.error('Error loading status:', error);
            document.getElementById('status-container').innerHTML = 
              '<div class="alert alert-danger">Failed to load status. Please refresh the page.</div>';
          });
      }
      
      updateStatus();
      setInterval(updateStatus, 60000); // Update every minute
      
      // Preview button
      document.getElementById('preview-btn').addEventListener('click', function() {
        const category = document.getElementById('category').value;
        if (!category) {
          alert('Please select a category');
          return;
        }
        
        document.getElementById('preview-btn').disabled = true;
        document.getElementById('preview-btn').textContent = 'Generating...';
        
        fetch('/api/test-tweet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            category,
            previewOnly: true
          })
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('preview-btn').disabled = false;
          document.getElementById('preview-btn').textContent = 'Preview Tweet';
          
          if (data.success) {
            document.getElementById('tweet-content').textContent = data.content.text;
            document.getElementById('tweet-hashtags').textContent = 
              data.content.hashtags ? `Hashtags: ${data.content.hashtags.join(', ')}` : '';
          } else {
            alert('Error generating preview: ' + data.message);
          }
        })
        .catch(error => {
          document.getElementById('preview-btn').disabled = false;
          document.getElementById('preview-btn').textContent = 'Preview Tweet';
          console.error('Error:', error);
          alert('Failed to generate preview. Please try again.');
        });
      });
      
      // Post tweet form
      document.getElementById('tweet-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const category = document.getElementById('category').value;
        if (!category) {
          alert('Please select a category');
          return;
        }
        
        if (!confirm('Are you sure you want to post this test tweet?')) {
          return;
        }
        
        const submitBtn = document.querySelector('#tweet-form button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Posting...';
        
        fetch('/api/test-tweet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            category,
            previewOnly: false
          })
        })
        .then(response => response.json())
        .then(data => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Post Test Tweet';
          
          if (data.success) {
            alert('Tweet posted successfully!');
            document.getElementById('tweet-content').textContent = data.content.text;
            document.getElementById('tweet-hashtags').textContent = 
              data.content.hashtags ? `Hashtags: ${data.content.hashtags.join(', ')}` : '';
          } else {
            alert('Error posting tweet: ' + data.message);
          }
        })
        .catch(error => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Post Test Tweet';
          console.error('Error:', error);
          alert('Failed to post tweet. Please try again.');
        });
      });
      
      // Engagement Rules
      function loadEngagementRules() {
        fetch('/api/engagement/rules')
          .then(response => response.json())
          .then(data => {
            renderRules(data.rules);
          })
          .catch(error => {
            console.error('Error loading rules:', error);
            document.getElementById('rules-container').innerHTML = 
              '<div class="alert alert-danger">Failed to load engagement rules. Please refresh the page.</div>';
          });
      }
      
      function renderRules(rules) {
        const container = document.getElementById('rules-container');
        container.innerHTML = '';
        
        if (!rules || rules.length === 0) {
          container.innerHTML = '<p>No engagement rules defined.</p>';
          return;
        }
        
        rules.forEach((rule, index) => {
          const ruleCard = document.createElement('div');
          ruleCard.className = 'card mb-3 rule-card';
          ruleCard.dataset.index = index.toString();
          
          ruleCard.innerHTML = `
            <div class="card-body">
              <div class="mb-2">
                <label class="form-label">Engagement Type</label>
                <select class="form-select rule-type">
                  <option value="like" ${rule.type === 'like' ? 'selected' : ''}>Like</option>
                  <option value="repost" ${rule.type === 'repost' ? 'selected' : ''}>Repost</option>
                  <option value="reply" ${rule.type === 'reply' ? 'selected' : ''}>Reply</option>
                  <option value="follow" ${rule.type === 'follow' ? 'selected' : ''}>Follow</option>
                  <option value="mention" ${rule.type === 'mention' ? 'selected' : ''}>Mention</option>
                  <option value="any" ${rule.type === 'any' ? 'selected' : ''}>Any</option>
                </select>
              </div>
              
              <div class="mb-2">
                <label class="form-label">Condition</label>
                <select class="form-select rule-condition">
                  <option value="count" ${rule.condition === 'count' ? 'selected' : ''}>Count</option>
                  <option value="verified" ${rule.condition === 'verified' ? 'selected' : ''}>Verified</option>
                  <option value="first_time" ${rule.condition === 'first_time' ? 'selected' : ''}>First Time</option>
                  <option value="art_focused" ${rule.condition === 'art_focused' ? 'selected' : ''}>Art Focused</option>
                </select>
              </div>
              
              <div class="mb-2 threshold-group" ${rule.condition !== 'count' ? 'style="display:none;"' : ''}>
                <label class="form-label">Threshold</label>
                <input type="number" class="form-control rule-threshold" min="1" value="${rule.threshold || 1}">
              </div>
              
              <div class="mb-2 timeframe-group" ${rule.condition !== 'count' ? 'style="display:none;"' : ''}>
                <label class="form-label">Timeframe (days)</label>
                <input type="number" class="form-control rule-timeframe" min="1" value="${rule.timeframe_days || 7}">
              </div>
              
              <div class="mb-2">
                <label class="form-label">Action</label>
                <select class="form-select rule-action">
                  <option value="reply" ${rule.action === 'reply' ? 'selected' : ''}>Reply</option>
                  <option value="log_only" ${rule.action === 'log_only' ? 'selected' : ''}>Log Only</option>
                </select>
              </div>
              
              <div class="mb-2">
                <label class="form-label">Priority</label>
                <input type="number" class="form-control rule-priority" min="1" value="${rule.priority}">
              </div>
              
              <button type="button" class="btn btn-sm btn-danger delete-rule-btn">Delete Rule</button>
            </div>
          `;
          
          container.appendChild(ruleCard);
          
          // Add event listener for condition change
          const conditionSelect = ruleCard.querySelector('.rule-condition');
          conditionSelect.addEventListener('change', function() {
            const thresholdGroup = ruleCard.querySelector('.threshold-group');
            const timeframeGroup = ruleCard.querySelector('.timeframe-group');
            
            if (this.value === 'count') {
              thresholdGroup.style.display = 'block';
              timeframeGroup.style.display = 'block';
            } else {
              thresholdGroup.style.display = 'none';
              timeframeGroup.style.display = 'none';
            }
          });
          
          // Add event listener for delete button
          const deleteBtn = ruleCard.querySelector('.delete-rule-btn');
          deleteBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this rule?')) {
              ruleCard.remove();
            }
          });
        });
      }
      
      // Add new rule
      document.getElementById('add-rule-btn').addEventListener('click', function() {
        const newRule = {
          type: 'like',
          condition: 'count',
          threshold: 3,
          timeframe_days: 7,
          action: 'reply',
          priority: 1
        };
        
        const currentRules = collectRulesFromUI();
        renderRules([...currentRules, newRule]);
      });
      
      // Save rules
      document.getElementById('save-rules-btn').addEventListener('click', function() {
        const rules = collectRulesFromUI();
        
        if (rules.length === 0) {
          alert('You must have at least one rule defined.');
          return;
        }
        
        const saveBtn = document.getElementById('save-rules-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        fetch('/api/engagement/rules', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ rules })
        })
        .then(response => response.json())
        .then(data => {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Rules';
          
          if (data.success) {
            alert('Engagement rules saved successfully!');
          } else {
            alert('Error saving rules: ' + data.message);
          }
        })
        .catch(error => {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Rules';
          console.error('Error:', error);
          alert('Failed to save rules. Please try again.');
        });
      });
      
      // Helper function to collect rules from UI
      function collectRulesFromUI() {
        const ruleCards = document.querySelectorAll('.rule-card');
        const rules = [];
        
        ruleCards.forEach(card => {
          const rule = {
            type: card.querySelector('.rule-type').value,
            condition: card.querySelector('.rule-condition').value,
            action: card.querySelector('.rule-action').value,
            priority: parseInt(card.querySelector('.rule-priority').value, 10)
          };
          
          if (rule.condition === 'count') {
            rule.threshold = parseInt(card.querySelector('.rule-threshold').value, 10);
            rule.timeframe_days = parseInt(card.querySelector('.rule-timeframe').value, 10);
          }
          
          rules.push(rule);
        });
        
        return rules;
      }
      
      // Load engagement rules
      loadEngagementRules();
      
      // Account Monitoring
      
      // Load accounts
      function loadAccounts() {
        fetch('/api/account-monitor/accounts')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              renderAccounts(data.accounts);
              populateAccountSelect(data.accounts);
            } else {
              document.getElementById('accounts-container').innerHTML = 
                '<div class="alert alert-danger">Failed to load accounts: ' + data.message + '</div>';
            }
          })
          .catch(error => {
            console.error('Error loading accounts:', error);
            document.getElementById('accounts-container').innerHTML = 
              '<div class="alert alert-danger">Failed to load accounts. Please refresh the page.</div>';
          });
      }
      
      // Render accounts table
      function renderAccounts(accounts) {
        const container = document.getElementById('accounts-container');
        
        if (!accounts || accounts.length === 0) {
          container.innerHTML = '<p>No accounts found. Add an account to get started.</p>';
          return;
        }
        
        let html = `
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Handle</th>
                  <th>Priority</th>
                  <th>Activity</th>
                  <th>Last Checked</th>
                  <th>Next Check</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        accounts.forEach(account => {
          const lastChecked = account.last_checked ? new Date(account.last_checked).toLocaleString() : 'Never';
          const nextCheck = account.next_check_date ? new Date(account.next_check_date).toLocaleString() : 'ASAP';
          
          html += `
            <tr>
              <td>${account.id}</td>
              <td>@${account.handle}</td>
              <td>${account.priority}</td>
              <td>${account.activity_level}</td>
              <td>${lastChecked}</td>
              <td>${nextCheck}</td>
              <td>
                <button class="btn btn-sm btn-primary view-tweets-btn" data-id="${account.id}" data-handle="${account.handle}">View Tweets</button>
                <button class="btn btn-sm btn-danger remove-account-btn" data-id="${account.id}" data-handle="${account.handle}">Remove</button>
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
        
        // Add event listeners for buttons
        document.querySelectorAll('.view-tweets-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const accountId = this.dataset.id;
            const handle = this.dataset.handle;
            
            // Switch to tweets tab
            document.getElementById('tweets-tab').click();
            
            // Select the account in the dropdown
            const select = document.getElementById('tweet-account-select');
            select.value = accountId;
            
            // Trigger change event
            const event = new Event('change');
            select.dispatchEvent(event);
          });
        });
        
        document.querySelectorAll('.remove-account-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const accountId = this.dataset.id;
            const handle = this.dataset.handle;
            
            if (confirm(`Are you sure you want to remove @${handle}?`)) {
              removeAccount(accountId);
            }
          });
        });
      }
      
      // Populate account select dropdown
      function populateAccountSelect(accounts) {
        const select = document.getElementById('tweet-account-select');
        
        // Clear existing options except the first one
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        if (!accounts || accounts.length === 0) {
          return;
        }
        
        accounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account.id;
          option.textContent = `@${account.handle}`;
          select.appendChild(option);
        });
        
        // Enable fetch button if accounts exist
        document.getElementById('fetch-tweets-btn').disabled = accounts.length === 0;
        
        // Add change event listener
        select.addEventListener('change', function() {
          if (this.value) {
            loadTweets(this.value);
          } else {
            document.getElementById('tweets-container').innerHTML = '<p>Select an account to view tweets</p>';
          }
        });
      }
      
      // Load tweets for an account
      function loadTweets(accountId) {
        document.getElementById('tweets-container').innerHTML = '<p>Loading tweets...</p>';
        
        fetch(`/api/account-monitor/tweets/${accountId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              renderTweets(data.tweets);
            } else {
              document.getElementById('tweets-container').innerHTML = 
                '<div class="alert alert-danger">Failed to load tweets: ' + data.message + '</div>';
            }
          })
          .catch(error => {
            console.error('Error loading tweets:', error);
            document.getElementById('tweets-container').innerHTML = 
              '<div class="alert alert-danger">Failed to load tweets. Please try again.</div>';
          });
      }
      
      // Render tweets
      function renderTweets(tweets) {
        const container = document.getElementById('tweets-container');
        
        if (!tweets || tweets.length === 0) {
          container.innerHTML = '<p>No tweets found for this account.</p>';
          return;
        }
        
        let html = `
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Tweet</th>
                  <th>Engagement</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        tweets.forEach(tweet => {
          const date = new Date(tweet.created_at).toLocaleString();
          const text = tweet.tweet_text.length > 100 
            ? tweet.tweet_text.substring(0, 100) + '...' 
            : tweet.tweet_text;
          
          html += `
            <tr>
              <td>${date}</td>
              <td>
                <a href="${tweet.tweet_url}" target="_blank">${text}</a>
              </td>
              <td>${tweet.engagement_score.toFixed(1)}</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      }
      
      // Add account
      document.getElementById('add-account-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const handle = document.getElementById('account-handle').value.trim();
        const priority = parseInt(document.getElementById('account-priority').value);
        const activityLevel = document.getElementById('account-activity').value;
        
        if (!handle) {
          alert('Please enter a handle');
          return;
        }
        
        // Remove @ if present
        const cleanHandle = handle.startsWith('@') ? handle.substring(1) : handle;
        
        const submitBtn = document.querySelector('#add-account-form button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        fetch('/api/account-monitor/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            handle: cleanHandle,
            priority,
            activityLevel
          })
        })
        .then(response => response.json())
        .then(data => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Add Account';
          
          if (data.success) {
            alert('Account added successfully!');
            document.getElementById('account-handle').value = '';
            loadAccounts();
          } else {
            alert('Error adding account: ' + data.message);
          }
        })
        .catch(error => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Add Account';
          console.error('Error:', error);
          alert('Failed to add account. Please try again.');
        });
      });
      
      // Remove account
      function removeAccount(accountId) {
        fetch('/api/account-monitor/remove', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            accountId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Account removed successfully!');
            loadAccounts();
          } else {
            alert('Error removing account: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to remove account. Please try again.');
        });
      }
      
      // Fetch tweets button
      document.getElementById('fetch-tweets-btn').addEventListener('click', function() {
        const accountId = document.getElementById('tweet-account-select').value;
        
        if (!accountId) {
          alert('Please select an account');
          return;
        }
        
        this.disabled = true;
        this.textContent = 'Fetching...';
        
        fetch('/api/account-monitor/fetch-tweets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            accountId: parseInt(accountId),
            count: 20
          })
        })
        .then(response => response.json())
        .then(data => {
          this.disabled = false;
          this.textContent = 'Fetch Tweets';
          
          if (data.success) {
            alert('Tweets fetched successfully!');
            renderTweets(data.tweets);
          } else {
            alert('Error fetching tweets: ' + data.message);
          }
        })
        .catch(error => {
          this.disabled = false;
          this.textContent = 'Fetch Tweets';
          console.error('Error:', error);
          alert('Failed to fetch tweets. Please try again.');
        });
      });
      
      // Process accounts button
      document.getElementById('process-accounts-btn').addEventListener('click', function() {
        const batchSize = parseInt(document.getElementById('batch-size').value);
        
        this.disabled = true;
        this.textContent = 'Processing...';
        
        document.getElementById('process-result').style.display = 'none';
        
        fetch('/api/account-monitor/process', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            batchSize
          })
        })
        .then(response => response.json())
        .then(data => {
          this.disabled = false;
          this.textContent = 'Process Accounts';
          
          document.getElementById('process-result').style.display = 'block';
          document.getElementById('process-result-message').textContent = data.message;
          
          if (data.success) {
            loadAccounts();
          }
        })
        .catch(error => {
          this.disabled = false;
          this.textContent = 'Process Accounts';
          console.error('Error:', error);
          
          document.getElementById('process-result').style.display = 'block';
          document.getElementById('process-result-message').textContent = 'Failed to process accounts. Please try again.';
        });
      });
      
      // Tab switching functionality
      document.querySelectorAll('#accountTabs .nav-link').forEach(tab => {
        tab.addEventListener('click', function() {
          // If switching to tweets tab, load tweets if an account is selected
          if (this.id === 'tweets-tab') {
            const accountId = document.getElementById('tweet-account-select').value;
            if (accountId) {
              loadTweets(accountId);
            }
          }
          
          // If switching to process tab, ensure the result container is hidden
          if (this.id === 'process-tab') {
            document.getElementById('process-result').style.display = 'none';
          }
        });
      });
      
      // Load accounts on page load
      loadAccounts();
    });
  </script>
</body>
</html>
